#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "../../../dependencies/tools/rstudio-tools.sh"

# Try to find node, and place it on the PATH.
NODE_PATHS=(
   "${SCRIPT_DIR}/../../../dependencies/common/node/${RSTUDIO_NODE_DIR}/bin"
   "/opt/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_DIR}/bin"
)

for NODE_PATH in "${NODE_PATHS[@]}"; do
	if [ -e "${NODE_PATH}" ]; then
		NODE_PATH=$(readlink -f "${NODE_PATH}")
		info "Using node: ${NODE_PATH}"
		PATH="${NODE_PATH}:${PATH}"
		break
	fi
done

# Set up a .Rprofile with some variables we want the
# running R sessions to see.
cp ~/.Renviron /tmp/.Renviron

cat <<- EOF >> /tmp/.Renviron
RSTUDIO_AUTOMATION_PORT = 59991
RSTUDIO_AUTOMATION_REUSE_REMOTE = TRUE
RSTUDIO_AUTOMATION_CLOSE_ON_FINISH = TRUE
EOF

export R_ENVIRON_USER=/tmp/.Renviron

rm -f rstudio-automation-results.xml
trap "exit" INT TERM
set -x
timeout 1h xvfb-run -a -s "-wr -screen 0 1024x768x24" npm run automation
set +x
cat rstudio-automation-results.xml

